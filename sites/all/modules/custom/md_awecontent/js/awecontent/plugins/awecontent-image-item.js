(function(a){AWEContent.Models.ImageItem=AWEContent.Models.Item.extend({imageURL:"",lighBoxImageURL:"",defaults:{fid:-1,machine_name:"image",styleImage:"none",styleLightbox:"none",lightBox:1,caption:1,captionColor:"",contentCaption:"",linkExtend:"",targetImage:1,positionCaption:"top",onHover:1,imageBgOverlay:"",captionOnLightBox:1,boxModelSettings:{},customID:"",customClass:"",customEnableAttributes:1,customDataAttributes:"[]",customActionAttributes:'{"newAction": "", "newAttrName": "", "newAttrValue": ""}',customEnableAnimations:0,customDataAnimations:'{"type" : "none"}',lgResponsive:true,xsResponsive:true,mediumResponsive:true,smResponsive:true},relations:[{type:Backbone.HasOne,key:"boxModelSettings",relatedModel:AWEContent.Models.BoxModelSettings}],createView:function(){this.view=new AWEContent.Views.ImageItem({model:this})},clone:function(){var b={};a.each(this.toJSON(),function(c,d){b[c]=d});b.boxModelSettings=new AWEContent.Models.BoxModelSettings(b.boxModelSettings);return new AWEContent.Models.ImageItem(b)}});AWEContent.Views.ImageItem=AWEContent.Views.Item.extend({imageContent:_.template('<div class="awe-item awe-image">            <% if (link) { %>                <a href="<%= link %>" target="<%= target %>" class="mgf-md-popup">            <% } %>                <div class="awe-image-content">                    <div class="awe-image-caption"><%= caption %></div>                    <div class="awe-image-container"><img src="<%= imgSrc %>" alt="" /></div>                </div>            <% if (link) { %>            </a>            <% } %>                <div class="awe-image-control">                    <ul>                        <li class="edit-link">                            <i class="ic ac-icon-link"></i>                            <div class="awe-control-box">                                <div class="awe-box-header">Image link</div>                                 <div class="awe-box-content">                                    <div class="awe-box-item">                                        <textarea></textarea>                                    </div>                                    <div class="awe-box-item">                                        <input type="checkbox" name="target" id="ckb-target" class="ckb-target">                                        <label for="ckb-target" class="label-checkbox">Open new window</label>                                    </div>                                </div>                                <div class="awe-box-footer">                                    <a href="#" class="awe-box-btn js-ok">Save</a>                                    <a href="#" class="awe-box-btn js-cancel">Cancel</a>                                </div>                            </div>                        </li>                        <li class="edit-caption">                            <i class="ic ac-icon-caption"></i>                            <div class="awe-control-box">                                <div class="awe-box-header">Image caption</div>                                 <div class="awe-box-content">                                    <div class="awe-box-item">                                        <textarea></textarea>                                    </div>                                </div>                                <div class="awe-box-footer">                                    <a href="#" class="awe-box-btn js-ok">Save</a>                                    <a href="#" class="awe-box-btn js-cancel">Cancel</a>                                </div>                            </div>                        </li>                    </ul>                </div>            </div>'),changeImageSrc:function(b){if(fid>0){this.model.set("fid",fid);AWEContent.Panels.image.setPanelElementsValue();this.resizeItem()}},initialize:function(){AWEContent.Views.Item.prototype.initialize.call(this);this.listenTo(this.model.get("boxModelSettings"),"change",this.applySettingsChanged);var b=this;this.$el.on("ready",function(){b.changeEmptyImageHeight();a(".awe-image",a(this)).aweDragUpload({multiUpload:false,uploadSuccessCallback:function(c){if(c.status&&c.file){var d=c.file;b.changeImageSrc(d.file_url)}}})});b.$el.delegate(".awe-image-control li","click",function(){a(this).siblings("li").removeClass("active");a(this).toggleClass("active");if(a(this).hasClass("active")){var c,d=a("textarea",this);if(a(this).hasClass("edit-link")){c=b.model.get("linkExtend")}else{if(a(this).hasClass("edit-caption")){c=b.model.get("contentCaption")}}d.val(c)}});b.$el.delegate(".awe-control-box","click",function(c){c.stopPropagation()});b.$el.delegate(".awe-image-control .awe-box-btn","click",function(f){f.preventDefault();f.stopPropagation();var c=a(f.target).is("li")?a(f.target):a(f.target).closest("li"),g=c.find("textarea"),h=c.find("input"),e=g.val();c.removeClass("active");if(a(this).hasClass("js-ok")){if(c.hasClass("edit-link")){var d=h.prop("checked")?1:0;b.model.set("linkExtend",e);b.model.set("targetImage",d)}else{if(c.hasClass("edit-caption")){b.model.set("contentCaption",e)}}}});this.$el.bind("getImageURLSuccess",function(d,c){})},changeEmptyImageHeight:function(){if(this.model.imageURL==""&&this.$img){this.$img.css("min-height",this.$el.width()*0.75)}},renderItemContent:function(){var d=this,e=d.model.toJSON(),g=(!e.lightBox&&e.linkExtend&&e.targetImage)?"_blank":"_self",f=(e.lightBox)?this.model.lighBoxImageURL:e.linkExtend,c=a(this.imageContent({link:f,target:g,imgSrc:this.model.imageURL,caption:e.contentCaption}));this.$el.aweImageURL({fid:[e.fid],styles:[e.styleImage,e.styleLightbox],success:function(i,k,j,h){d.processImageURL(i,k,j,h)}});d.$imageWrap=c;if(f){d.$imageWrap=a("> a",c)}AWEContent.Library.addLibrary("magnific",function(){d.initMagnificPopup(c)});if(e.caption){if(e.positionCaption=="bottom"){a(".awe-image-content",c).append(a(".awe-image-caption",c))}else{if(e.positionCaption=="over"){c.addClass("position-over");if(e.onHover){c.addClass("caption-hover")}a(".awe-image-content",d.$imageWrap).prepend(a('<div class="awe-image-overlay"></div>').css("background-color",e.imageBgOverlay))}}}else{c.addClass("disable-caption")}if(e.lightBox){d.$imageWrap.addClass("open-lightbox")}a(".awe-image-caption",c).attr("data-on-lightbox",e.captionOnLightBox?true:false);c.attr("id",e.customID).addClass(e.customClass).renderItemDefaultBoxModel(e.boxModelSettings);c.renderItemDefaultAttributes(e.customEnableAttributes,e.customDataAttributes);if(e.customEnableAnimations){c.processAnimations(e.customDataAnimations)}d.$el.defaultResponsive(e);d.$img=a(".awe-image-container > img",c);a(".awe-image-caption",c).css("color",e.captionColor);var b=setInterval(function(){if(d.$el.find("img").length!=0){clearInterval(b);d.resizeItem()}},100);return c},applySettingsChanged:function(d){var c=this,e=c.model.toJSON(),b=a(".awe-image",c.el),h=a(".awe-image-content",b),g=a(".awe-image-caption",b),f=c.$el.height();a.each(d.changedAttributes(),function(j,l){c.$el.changeResponsive(j,l);b.renderChangeSettingBoxModel(j,l,d);switch(j){case"fid":var o=d.previousAttributes().fid;if(o==-1){c.$img.css({"min-height":"",background:""})}c.$el.aweImageURL({fid:[e.fid],styles:[e.styleImage,e.styleLightbox],success:function(q,s,r,p){c.processImageURL(q,s,r,p)}});break;case"styleImage":case"styleLightbox":var n=c.model.get("fid");if(n>0){c.$el.aweImageURL({fid:[e.fid],styles:[e.styleImage,e.styleLightbox],success:function(q,s,r,p){c.processImageURL(q,s,r,p)}})}break;case"lightBox":if(l){if(e.linkExtend==""){c.$imageWrap.prepend('<a href="mgf-md-popup"></a>');c.$imageWrap=a("> a",c.$imageWrap);c.$imageWrap.append(a(".awe-image-content",b))}c.$imageWrap.attr("href",c.model.lighBoxImageURL).addClass("open-lightbox");a("li.edit-link",b).hide()}else{if(e.linkExtend==""){c.$imageWrap=b;c.$imageWrap.append(a(".awe-image-content",b));a("> a",b).remove()}else{c.$imageWrap.removeClass("open-lightbox").attr("href",e.linkExtend)}a("li.edit-link",b).show();if(!e.caption){a("li.edit-caption",b).hide()}}break;case"linkExtend":if(!e.lightBox){if(l){b.prepend('<a class="mgf-md-popup" href=""></a>');c.$imageWrap=a("> a",b).attr("href",l);c.$imageWrap.append(a(".awe-image-content",b))}else{b.prepend(a(".awe-image-content",b));a("> a.mgf-md-popup",b).remove();c.$imageWrap=a(".awe-image-content",b)}}break;case"targetImage":if(e.linkExtend){c.$imageWrap.attr("target",l?"_blank":"_blank")}break;case"caption":if(l){a(".edit-caption",b).show();if(e.contentCaption!=""){b.removeClass("disable-caption")}}else{b.addClass("disable-caption");if(!e.captionOnLightBox||!e.lightBox){a(".edit-caption",b).hide()}}break;case"contentCaption":if(e.caption&&l!=""){b.removeClass("disable-caption");a(".awe-image-caption",b).html(l)}else{b.addClass("disable-caption")}break;case"positionCaption":b.removeClass("position-over").removeClass("caption-hover");switch(l){case"top":h.prepend(g);a(".awe-image-overlay",b).remove();break;case"bottom":h.append(g);a(".awe-image-overlay",b).remove();break;case"over":b.addClass("position-over");if(e.onHover){b.addClass("caption-hover")}a(".awe-image-content",c.$imageWrap).prepend(a('<div class="awe-image-overlay"></div>').css("background-color",e.imageBgOverlay));break}break;case"onHover":l&&e.positionCaption=="over"?b.addClass("caption-hover"):b.removeClass("caption-hover");break;case"captionOnLightBox":if(l){a(".edit-caption",b).show();g.attr("data-on-lightbox",true)}else{g.attr("data-on-lightbox",false);if(!e.caption){a(".edit-caption",b).hide()}}break;case"captionColor":a(".awe-image-caption",b).css("color",l);break;case"imageBgOverlay":a(".awe-image-overlay",b).css("background-color",l);break;case"customID":b.attr("id",l);break;case"customClass":var m=c.model.previousAttributes().customClass;b.removeClass(m).addClass(l);break;case"customEnableAttributes":b.renderChangeSettingsAttributes(j,l,e.customDataAttributes);break;case"customActionAttributes":b.renderChangeSettingsAttributes(j,l);break;case"customEnableAnimations":var k,i;if(l){k=e.customDataAnimations;i=null;b.processAnimations(k)}else{k=null;i=e.customDataAnimations;b.processAnimations(k,i)}break;case"customDataAnimations":var k,i;k=e.customDataAnimations;i=c.model.previousAttributes().customDataAnimations;b.processAnimations(k,i);break}});setTimeout(function(){c.checkChangeHeight(f)},100)},initMagnificPopup:function(b){AWEContent.jqIframe(b).magnificPopup({delegate:".open-lightbox",type:"image",removalDelay:300,mainClass:"mfp-fade",prependTo:".awe-page-wrapper",callbacks:{markupParse:function(d,c,e){var f=e.el.closest(".awe-item").find(".awe-image-caption");if(f.attr("data-on-lightbox")=="true"){c.title=a("<div />").html(f.text()).css("color",f.css("color"))}else{c.title=""}}},image:{headerFit:true,captionFit:true,preserveHeaderAndCaptionWidth:false}})},processImageURL:function(e,i,g,f){var i=this.model.get("fid"),d=this.model.get("styleImage"),h=this.model.get("styleLightbox"),c=f&&f[i]?f[i]:null;if(c&&c[d]!==undefined){this.model.imageURL=c[d];a("img",this.$el).attr("src",c[d])}if(c&&c[h]!==undefined){this.model.lighBoxImageURL=c[h];if(this.model.get("lightBox")){var b=a(".awe-image",this.el);if(a("> a",b).length==0){b.prepend('<a class="mgf-md-popup" href=""></a>');a("> a",b).append(a(".awe-image-content",b))}this.$imageWrap=a("> a",b);this.$imageWrap.addClass("open-lightbox").attr("href",c[h])}}}});AWEContent.Views.ImageItemController=AWEContent.Views.ItemController.extend({machineName:"image",controllerHtml:function(){return'<div class="title-icon">Image</div><i class="ic ac-icon-image2"></i>'},createItemModel:function(b){var d,c;if(b!=undefined){d=new AWEContent.Models.BoxModelSettings(b.boxModelSettings);b.boxModelSettings=d;c=new AWEContent.Models.ImageItem(b)}else{c=new AWEContent.Models.ImageItem({boxModelSettings:new AWEContent.Models.BoxModelSettings({enabledCustomBorder:1})});c.imageURL=c.lighBoxImageURL=AWEContent.Path.defaultImage}return c}});AWEContent.Views.ImagePanel=AWEContent.Views.ItemPanel.extend({tagName:"div",className:"awe-obj-panel image-panel",panelName:"image",initPanel:function(){AWEContent.Views.ItemPanel.prototype.initPanel.call(this);var b=this;b.$el.mousedown(function(){if(AWEContent.jqIframe(".mfp-close-btn-in").length){AWEContent.jqIframe(".mfp-close-btn-in").trigger("click")}});a(".color-picker",b.el).append('<input type="hidden" name="changing-color">');a("#image-select-image input[name=selected_media]",b.el).change(function(){var e=a(this).val().trim(),d=e?JSON.parse(e):false,c=d&&d.file_url?d.file_url:"",f=d&&d.fid>0?d.fid:-1;a(".image-content > img",b.$el).attr("src",c);b.editingModel.set("fid",f)});a("#image-thumb-style",this.el).change(function(d,c){b.editingModel.set("styleImage",c.value)});a("#image-enable-lightbox input[name=toggle_value]",this.el).change(function(d,c){var e=parseInt(a(this).val());if(!c){b.editingModel.set("lightBox",e)}if(e){a("#image-on-lightbox , #image-lightbox-style, .image-lb-title",b.el).show()}else{a("#image-on-lightbox, #image-lightbox-style, .image-lb-title",b.el).hide()}a("#image-caption-color",b.el).show();if(!b.editingModel.get("caption")&&(!e||!b.editingModel.get("captionOnLightBox"))){a("#image-caption-color",b.el).hide()}});a("#image-lightbox-style",this.el).change(function(d,c){b.editingModel.set("styleLightbox",c.value)});a("#image-enable-caption input[name=toggle_value]",this.el).change(function(d,c){var e=parseInt(a(this).val());if(!c){b.editingModel.set("caption",e)}a("#image-position, #image-on-hover, #image-image-bg-overlay",b.el).hide();if(e){a("#image-position",b.el).show();if(b.editingModel.get("positionCaption")=="over"){a("#image-on-hover, #image-image-bg-overlay",b.el).show()}}a("#image-caption-color",b.el).show();if(!e&&(!b.editingModel.get("lightBox")||!b.editingModel.get("captionOnLightBox"))){a("#image-caption-color",b.el).hide()}});a("#image-position",this.el).change(function(d,c){b.editingModel.set("positionCaption",c.value);a("#image-on-hover, #image-image-bg-overlay",b.el).hide();if(c.value=="over"&&b.editingModel.get("caption")){a("#image-on-hover, #image-image-bg-overlay",b.el).show()}});a("#image-on-hover input[name=toggle_value]",this.el).change(function(d,c){if(!c){b.editingModel.set("onHover",parseInt(a(this).val()))}});a("#image-image-bg-overlay",b.el).change(function(d,c){c=c?c.toRgbString():"";b.editingModel.set("imageBgOverlay",c)});a("#image-caption-color",b.el).change(function(d,c){c=c?c.toRgbString():"";b.editingModel.set("captionColor",c)});a("#image-on-lightbox input[name=toggle_value]",this.el).change(function(d,c){var e=parseInt(a(this).val());if(!c){b.editingModel.set("captionOnLightBox",e)}a("#image-caption-color",b.el).show();if((!e||!b.editingModel.get("lightBox"))&&!b.editingModel.get("caption")){a("#image-caption-color",b.el).hide()}});a("#image-layout-tab",this.el).initBoxModelPanel(this,"boxModelSettings");a("#text-image-custom-id",this.el).change(function(){b.editingModel.set("customID",a(this).val())});a("#text-image-custom-classes",this.el).change(function(){b.editingModel.set("customClass",a(this).val())});a("#image-custom-attributes",this.el).initAttributesPanel(b);a("#image-animations",this.el).change(function(c,d){b.editingModel.set("customEnableAnimations",d.enabled);if(d){b.editingModel.set("customDataAnimations",d.animations)}})},setPanelElementsValue:function(){var b=this,c=this.editingModel.toJSON();a("#image-select-image img",b.el).attr("src",b.editingModel.imageURL);if(AWEContent.Path.imageStyleURL!=""){a("#image-thumb-style",b.el).aweSelect("value",c.styleImage);a("#image-lightbox-style",b.el).aweSelect("value",c.styleLightbox)}else{a("#image-thumb-style, #image-lightbox-style",b.el).remove()}a("#image-enable-lightbox input[name=toggle_value]",b.el).val(c.lightBox).trigger("change",true);a("#image-enable-caption input[name=toggle_value]",b.el).val(c.caption).trigger("change",true);a("#image-position",b.el).aweSelect("value",c.positionCaption);a("#image-on-hover input[name=toggle_value]",b.el).val(c.onHover).trigger("change",true);a("#image-image-bg-overlay",b.el).aweColorPicker("value",c.imageBgOverlay);a("#image-caption-color",b.el).aweColorPicker("value",c.captionColor);a("#image-on-lightbox input[name=toggle_value]",b.el).val(c.captionOnLightBox).trigger("change",true);a("#image-layout-tab",b.el).initBoxModel(c.boxModelSettings);a("#text-image-custom-id",b.el).val(c.customID);a("#text-image-custom-classes",b.el).val(c.customClass);a("#image-custom-attributes",this.el).initAttributes(c.customEnableAttributes,c.customDataAttributes);a("#image-animations",this.el).aweAnimation("value",{enabled:c.customEnableAnimations,animations:c.customDataAnimations,previewEl:b.editingModel.view.$el})},buildPanel:function(){return{title:{type:"markup",markup:'<div class="awe-title"><h2>Image</h2></div>'},custom_style:{type:"section",select_image:{type:"button",title:"Select Image"},thumb_style:{type:"image_style_list",title:"Image Style",attributes:{"class":["long-title"]}},enable_lightbox:{type:"toggle",title:"Enable Lightbox",default_value:0},lightbox_style:{type:"image_style_list",title:"LightBox Image Style",attributes:{"class":["long-title"]}}},custom_caption:{type:"section",enable_caption:{type:"toggle",title:"Caption",default_value:0},caption_color:{type:"colorpicker",title:"Caption Color",options:{preferredFormat:"rgb",AlphaVerticle:true,showAlpha:true,allowEmpty:true,showInput:true}},position:{type:"select",title:"Position",options:{top:"Top",bottom:"Bottom",over:"Over"},default_value:"top"},on_hover:{type:"toggle",title:"Display on hover",default_value:0},image_bg_overlay:{type:"colorpicker",title:"BgOverlay",options:{preferredFormat:"rgb",AlphaVerticle:true,showAlpha:true,allowEmpty:true,showInput:true}},on_lightbox:{type:"toggle",title:"Caption on lightbox",default_value:0}},box_settings:{type:"section",layout_tab:{type:"tabs",tabs:[{tab_title:"Border",contents:{header_border:{type:"box_border",min_value:0,max_value:100,default_value:0}}},{tab_title:"Radius",contents:{header_boder_radius:{type:"box_model",model_type:"border_radius",min_value:0,max_value:100,allow_type:true}}},{tab_title:"Padding",contents:{header_padding:{type:"box_model",model_type:"padding",allow_type:true,min_value:0,max_value:100}}},{tab_title:"Margin",contents:{header_margin:{type:"box_model",model_type:"margin",allow_type:true,min_value:0,max_value:100}}}]}},definitions:{type:"section",custom_id:{type:"text_field",title:"ID",default_value:""},custom_classes:{type:"text_field",title:"Class",default_value:""},custom_attributes:{type:"custom_attributes"},animations:{type:"animations"}}}}});a(document).ready(function(){AWEContent.Controllers.image=new AWEContent.Views.ImageItemController();AWEContent.Panels.image=new AWEContent.Views.ImagePanel()})})(jQuery);